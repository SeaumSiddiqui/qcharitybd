services:
  mysql:
    image: mysql:8.0
    container_name: mysql
    restart: unless-stopped
    env_file:
      - ./.env
    environment:
      MYSQL_ROOT_PASSWORD: ${MYSQL_ROOT_PASSWORD}
      MYSQL_DATABASE: ${MYSQL_DATABASE}
      MYSQL_USER: ${MYSQL_USER}
      MYSQL_PASSWORD: ${MYSQL_PASSWORD}
    volumes:
      - mysql_data:/var/lib/mysql
      - ./mysql/init.sql:/docker-entrypoint-initdb.d/init.sql:ro
    networks:
      - charity_portal_network
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost"]
      interval: 30s
      timeout: 10s
      retries: 5

  keycloak:
    image: quay.io/keycloak/keycloak:25.0.2
    container_name: keycloak
    restart: unless-stopped
    env_file:
      - ./.env
    environment:
      KC_DB: mysql
      KC_DB_URL: jdbc:mysql://mysql:3306/kcdb
      # ensure Keycloak gets the DB credentials (explicit mapping to .env)
      KC_DB_USERNAME: ${KC_DB_USERNAME}
      KC_DB_PASSWORD: ${KC_DB_PASSWORD}
      # admin bootstrap (still in .env too)
      KEYCLOAK_ADMIN: ${KEYCLOAK_ADMIN}
      KEYCLOAK_ADMIN_PASSWORD: ${KEYCLOAK_ADMIN_PASSWORD}
      KC_HOSTNAME: qcharitybd.com
      KC_PROXY: edge
    command: ["start", "--hostname-strict=false", "--http-enabled=true", "--http-port=8080"]
    depends_on:
      - mysql
    networks:
      - charity_portal_network
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:8080/health/ready || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 5

  charity-portal-api:
    container_name: charity-portal-api
    build:
      context: /home/seaum/charity-portal-api
      dockerfile: Dockerfile
    restart: unless-stopped
    env_file:
      - ../charity-portal-api/.env
      - ./.env
    depends_on:
      - mysql
      - keycloak
    networks:
      - charity_portal_network
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
#    healthcheck:
#      test: ["CMD-SHELL", "wget -qO- http://localhost:5050/actuator/health || exit 1"]
#      interval: 30s
#      timeout: 10s
#      retries: 5

  charity-portal-ui:
    container_name: charity-portal-ui
    build:
      context: /home/seaum/charity-portal-ui
      dockerfile: Dockerfile
      args:
        BUILD_ENV: production
    restart: unless-stopped
    depends_on:
      - charity-portal-api
      - keycloak
    networks:
      - charity_portal_network
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  caddy:
    image: caddy:2
    container_name: caddy
    restart: unless-stopped
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - caddy_data:/data
      - caddy_config:/config
      - ./caddy/Caddyfile:/etc/caddy/Caddyfile:ro
    depends_on:
      - charity-portal-ui
      - charity-portal-api
      - keycloak
    networks:
      - charity_portal_network
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

networks:
  charity_portal_network:

volumes:
  mysql_data:
  caddy_data:
  caddy_config:
